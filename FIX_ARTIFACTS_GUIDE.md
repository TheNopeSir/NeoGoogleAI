# Руководство по исправлению данных артефактов

## Проблема

В базе данных обнаружены следующие проблемы:
- ❌ Описания артефактов отображаются как "обрывки" или отсутствуют
- ❌ Комментарии артефактов отсутствуют (поле `comments` не инициализировано)
- ❌ Характеристики артефактов отсутствуют (поле `specs` не инициализировано)

## Решение

Созданы скрипты миграции для автоматического исправления данных.

## Файлы миграции

1. **`migrations/fix-artifact-descriptions.sql`** - SQL скрипт для быстрого исправления
2. **`migrations/fix-artifacts-migration.js`** - Node.js скрипт с детальным логированием

## Инструкция по применению

### Способ 1: SQL миграция (рекомендуется для быстрого исправления)

#### Через psql (командная строка)

```bash
psql -h 185.152.92.64 -U gen_user -d default_db -f migrations/fix-artifact-descriptions.sql
```

#### Через Supabase SQL Editor

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте содержимое файла `migrations/fix-artifact-descriptions.sql`
4. Вставьте в редактор и нажмите "Run"
5. Проверьте результаты выполнения

### Способ 2: Node.js скрипт (для детального анализа)

#### Шаг 1: Настройка окружения

Создайте файл `.env` в корне проекта (если его нет):

```env
DB_USER=gen_user
DB_PASSWORD=9H@DDCb.gQm.S}
DB_HOST=185.152.92.64
DB_NAME=default_db
```

#### Шаг 2: Установка зависимостей

```bash
npm install
```

#### Шаг 3: Предварительный просмотр (Dry-Run)

```bash
node migrations/fix-artifacts-migration.js --dry-run
```

Этот режим покажет, какие изменения будут применены, но НЕ изменит данные в БД.

#### Шаг 4: Применение миграции

```bash
node migrations/fix-artifacts-migration.js
```

## Что делает миграция

### 1. Исправление описаний

**До:**
```json
{
  "title": "Nokia 3310",
  "description": ""
}
```

**После:**
```json
{
  "title": "Nokia 3310",
  "description": "Nokia 3310 - уникальный экспонат коллекции. Категория: ТЕЛЕФОНЫ."
}
```

### 2. Добавление массива комментариев

**До:**
```json
{
  "title": "Sega Genesis"
  // Поле comments отсутствует
}
```

**После:**
```json
{
  "title": "Sega Genesis",
  "comments": []
}
```

### 3. Добавление объекта характеристик

**До:**
```json
{
  "title": "Sony Walkman"
  // Поле specs отсутствует
}
```

**После:**
```json
{
  "title": "Sony Walkman",
  "specs": {}
}
```

## Безопасность

✅ **Миграция безопасна:**
- Не удаляет существующие данные
- Только добавляет отсутствующие поля
- Не изменяет корректные описания
- Поддерживает режим dry-run для предварительного просмотра

## Проверка результатов

После применения миграции выполните SQL запрос:

```sql
SELECT
    COUNT(*) as total_artifacts,
    COUNT(CASE WHEN data->>'description' IS NOT NULL AND LENGTH(TRIM(data->>'description')) >= 5 THEN 1 END) as with_description,
    COUNT(CASE WHEN data->'comments' IS NOT NULL AND jsonb_typeof(data->'comments') = 'array' THEN 1 END) as with_comments,
    COUNT(CASE WHEN data->'specs' IS NOT NULL AND jsonb_typeof(data->'specs') = 'object' THEN 1 END) as with_specs
FROM exhibits;
```

Все три счетчика должны быть равны `total_artifacts`.

## Устранение проблем

### Ошибка: "Connection timeout"

**Причина:** База данных недоступна из текущего окружения.

**Решение:**
1. Запустите миграцию на сервере, где работает основное приложение
2. Или используйте SQL миграцию через Supabase Dashboard

### Ошибка: "Permission denied"

**Причина:** Недостаточно прав для изменения таблицы `exhibits`.

**Решение:**
1. Используйте учетную запись с правами на UPDATE
2. Или обратитесь к администратору БД

## Откат изменений

Миграция **не требует отката**, так как только добавляет отсутствующие данные. Если необходимо вернуть исходное состояние, восстановите из резервной копии БД.

## Вопросы и поддержка

Если у вас возникли вопросы:
1. Проверьте логи выполнения миграции
2. Убедитесь, что БД доступна
3. Проверьте правильность учетных данных в `.env`

---

**Дата создания:** 2026-01-11
**Автор:** Claude Code Agent
